<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ระบบจัดตารางสอน — เพิ่มข้อมูล</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
        rel="stylesheet">

  <style>
    body { 
      background-color: #eaedffff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    /* ความสูง navbar โดยประมาณ ใช้กับ sticky sidebar */
    :root { --nav-h: 76px; }

    /* Updated header styling to match other pages */
    .header-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Updated navigation styling to match other pages */
    .nav-tabs .nav-link {
      border: none;
      color: #6b7280;
      font-weight: 500;
      padding: 1rem 1.5rem;
      border-bottom: 3px solid transparent;
      background: none;
    }
    
    .nav-tabs .nav-link.active {
      background: none;
      color: #4f46e5;
      border-bottom-color: #4f46e5;
    }
    
    .nav-tabs .nav-link:hover {
      border-color: transparent;
      color: #374151;
      background: none;
    }

    .sidebar-sticky {
      position: sticky;
      top: var(--nav-h);
    }
    .side-link { display: flex; align-items: center; gap: .5rem; }
    .side-link .bi { font-size: 1.05rem; opacity: .9; }
    
    /* Updated card styling to match other pages */
    .card { 
      border: 2px solid #d1d5db !important;
      border-radius: 16px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      background: white;
      transition: all 0.2s;
    }
    
    .card:hover {
      border-color: #9ca3af !important;
      box-shadow: 0 8px 12px -2px rgba(0, 0, 0, 0.15);
    }
    
    .card-header {
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      color: white;
      padding: 1.5rem;
      border: none;
      border-radius: 14px 14px 0 0 !important;
    }

    /* Added consistent button styling */
    .btn-primary-gradient {
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      border: none;
      border-radius: 12px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      transition: all 0.2s;
      color: white;
    }
    
    .btn-primary-gradient:hover {
      background: linear-gradient(135deg, #4338ca, #6d28d9);
      transform: translateY(-1px);
      color: white;
    }

    /* Added form styling consistency */
    .form-control, .form-select {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 0.75rem 1rem;
      transition: all 0.2s;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 0.2rem rgba(79, 70, 229, 0.25);
    }

    /* Added notification system styling */
    .notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      max-width: 400px;
    }

    .notification {
      padding: 15px 20px;
      margin-bottom: 10px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .notification.show {
      opacity: 1;
      transform: translateX(0);
    }

    .notification.success {
      background-color: #d1fae5;
      border-left: 4px solid #10b981;
      color: #065f46;
    }

    .notification.error {
      background-color: #fee2e2;
      border-left: 4px solid #ef4444;
      color: #991b1b;
    }

    .notification.warning {
      background-color: #fef3c7;
      border-left: 4px solid #f59e0b;
      color: #92400e;
    }

    .notification.info {
      background-color: #dbeafe;
      border-left: 4px solid #3b82f6;
      color: #1e40af;
    }

    .notification-close {
      position: absolute;
      top: 5px;
      right: 10px;
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      opacity: 0.7;
    }

    .notification-close:hover {
      opacity: 1;
    }

    .notification-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background-color: rgba(0,0,0,0.2);
      transition: width linear;
    }

    .table-rounded { border: 2px solid #e5e7eb; border-radius: 14px; overflow: hidden; }
    .table-rounded thead th { background: #f8fafc; font-weight: 600; color: #374151; }
    .empty-row { height: 72px; }

  </style>
</head>
<body>

  <!-- Added notification container -->
  <div class="notification-container" id="notificationContainer"></div>

  <!-- Updated header to match other pages -->
  <header class="bg-white border-bottom py-3">
    <div class="container-fluid" style="max-width: 1400px;">
      <div class="row align-items-center">
        <div class="col-md-6">
          <div class="d-flex align-items-center">
            <div class="header-icon me-3">
              <i class="bi bi-calendar-check text-white fs-4"></i>
            </div>
            <h1 class="h4 mb-0 fw-bold text-dark">ระบบจัดตารางสอน</h1>
          </div>
        </div>
        <div class="col-md-6">
          <div class="d-flex justify-content-end align-items-center">
            <button class="btn btn-outline-secondary me-3">
              <i class="bi bi-file-text me-2"></i>คู่มือ
            </button>
            <button class="btn btn-outline-primary">
              <i class="bi bi-person me-2"></i>เกี่ยวกับเรา
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Navigation -->
  <nav class="bg-white border-bottom">
    <div class="container-fluid" style="max-width: 1400px;">
      <ul class="nav nav-tabs border-0">
        <li class="nav-item">
          <a class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}"
             href="{% url 'home' %}" {% if request.resolver_match.url_name == 'home' %}aria-current="page"{% endif %}>
            <i class="bi bi-house me-2"></i>หน้าหลัก
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if request.resolver_match.url_name == 'add' %}active{% endif %}"
             href="{% url 'add' %}" {% if request.resolver_match.url_name == 'add' %}aria-current="page"{% endif %}>
            <i class="bi bi-plus-square me-2"></i>เพิ่มข้อมูล
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if request.resolver_match.url_name == 'pre' %}active{% endif %}"
             href="{% url 'pre' %}" {% if request.resolver_match.url_name == 'pre' %}aria-current="page"{% endif %}>
            <i class="bi bi-book me-2"></i>ลงล่วงหน้า
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if request.resolver_match.url_name == 'teacher' %}active{% endif %}"
             href="{% url 'teacher' %}" {% if request.resolver_match.url_name == 'teacher' %}aria-current="page"{% endif %}>
            <i class="bi bi-people me-2"></i>รายวิชา
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if request.resolver_match.url_name == 'activities' %}active{% endif %}"
             href="{% url 'activities' %}" {% if request.resolver_match.url_name == 'activities' %}aria-current="page"{% endif %}>
            <i class="bi bi-activity me-2"></i>กิจกรรม
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- =================== MAIN: SIDEBAR + TAB CONTENT =================== -->
  <div class="container-fluid py-4" style="max-width: 1400px;">
    <div class="row g-4">

      <!-- ========== SIDEBAR (แท็บด้านข้าง) ========== -->
      <aside class="col-12 col-md-3 col-lg-2">
        <div class="card shadow-sm sidebar-sticky">
          <div class="card-header">
            <h6 class="mb-0 d-flex align-items-center">
              <i class="bi bi-plus-square me-2"></i>
              เมนูเพิ่มข้อมูล
            </h6>
          </div>
          <div class="card-body p-2">
            <div class="nav nav-pills flex-column" id="sideTab" role="tablist"
                 aria-orientation="vertical">

              <a class="nav-link active side-link" id="t-subject-tab" data-bs-toggle="pill"
                href="#t-subject" role="tab" aria-controls="t-subject" aria-selected="true">
                  <i class="bi bi-journal-bookmark"></i> ข้อมูลรายวิชา
              </a>

              <a class="nav-link side-link" id="t-teacher-tab" data-bs-toggle="pill"
                href="#t-teacher" role="tab" aria-controls="t-teacher" aria-selected="false">
                  <i class="bi bi-person-workspace"></i> ข้อมูลอาจารย์ผู้สอน
              </a>

              <a class="nav-link side-link" id="t-studentgroup-tab" data-bs-toggle="pill"
                href="#t-studentgroup" role="tab" aria-controls="t-studentgroup">
                  <i class="bi bi-people-fill"></i> ข้อมูลกลุ่มนักศึกษา
              </a>

              <a class="nav-link side-link" id="t-grouptype-tab" data-bs-toggle="pill"
                 href="#t-grouptype" role="tab" aria-controls="t-grouptype">
                <i class="bi bi-building"></i> ข้อมูลภาคนักศึกษา
              </a>

              <a class="nav-link side-link" id="t-groupallow-tab" data-bs-toggle="pill"
                 href="#t-groupallow" role="tab" aria-controls="t-groupallow">
                <i class="bi bi-person-badge"></i> ข้อมูลคาบที่เรียนได้
              </a>

              <a class="nav-link side-link" id="t-room-tab" data-bs-toggle="pill"
                 href="#t-room" role="tab" aria-controls="t-room">
                <i class="bi bi-calendar2-week"></i> ข้อมูลห้องเรียน
              </a>

              <a class="nav-link side-link" id="t-roomtype-tab" data-bs-toggle="pill"
                 href="#t-roomtype" role="tab" aria-controls="t-roomtype">
               <i class="bi bi-grid-3x3-gap"></i> ข้อมูลประเภทห้องเรียน
              </a>

              <a class="nav-link side-link" id="t-timeslot-tab" data-bs-toggle="pill"
                 href="#t-timeslot" role="tab" aria-controls="t-timeslot">
                <i class="bi bi-alarm"></i> ข้อมูลคาบเวลา
              </a>

              <a class="nav-link side-link" id="t-weekactivity-tab" data-bs-toggle="pill"
                href="#t-weekactivity" role="tab" aria-controls="t-weekactivity">
                  <i class="bi bi-calendar-event"></i> ข้อมูลกิจกรรม
              </a>

            </div>
          </div>
        </div>
      </aside>

      <!-- ========== CONTENT (สลับภายในหน้าเดียว) ========== -->
      <main class="col-12 col-md-9 col-lg-10">
        <div class="tab-content" id="sideTabContent">

          <!-- ข้อมูลรายวิชา -->
          <div class="tab-pane fade" id="t-subject" role="tabpanel" aria-labelledby="t-subject-tab">
            <div class="card shadow-sm">
              <div class="card-header">
                <h5 class="mb-0 d-flex align-items-center">
                  <!-- แก้ชื่อไอคอนให้ถูก -->
                  <i class="bi bi-cloud-upload me-2"></i>ข้อมูลรายวิชา
                </h5>
              </div>
              <div class="card-body p-4">
                <!-- ฟอร์มตัวอย่าง ยังไม่ผูก backend -->
                <form id="subjectForm" class="row g-2" method="post">
                  <!-- {% csrf_token %} -->
                  <div class="col-md">
                    <label class="form-label" for="subject_name">ชื่อรายวิชา</label>
                    <input id="subject_name" type="text" class="form-control" placeholder="กรอกชื่อรายวิชา">
                  </div>
                  <div class="col-12">
                    <div class="d-flex justify-content-end mt-3">
                      <button id="btnAddSubject" type="button" class="btn btn-primary-gradient px-4">
                        <i class="bi bi-plus-lg me-2"></i>เพิ่มข้อมูล
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>

            <!-- ตารางรายวิชา (ให้อยู่ในแท็บเดียวกัน) -->
            <div class="card shadow-sm mt-4">
              <div class="card-header d-flex align-items-center">
                <i class="bi bi-table me-2"></i>
                <h5 class="mb-0">รายการรายวิชา</h5>
              </div>
              <div class="card-body p-4">
                <div class="table-responsive table-rounded">
                  <table class="table align-middle mb-0">
                    <thead>
                      <tr>
                        <th>ชื่อรายวิชา</th>
                        <th>จัดการ</th>
                      </tr>
                    </thead>
                    <tbody id="subjectTableBody">
                      <tr class="empty-row">
                        <td colspan="3" class="text-center text-muted">ไม่มีข้อมูลรายวิชา</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div class="d-flex justify-content-between mt-4">
                  <button id="btnRefreshSubject" class="btn btn-success btn-lg px-4">
                    <i class="bi bi-arrow-clockwise me-2"></i>รีเฟรช
                  </button>
                  <button id="btnExportSubjectCSV" class="btn btn-success btn-lg px-4">
                    <i class="bi bi-download me-2"></i>ดาวน์โหลด CSV
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ข้อมูลอาจารย์ผู้สอน -->
          <div class="tab-pane fade show active" id="t-teacher" role="tabpanel" aria-labelledby="t-teacher-tab">
            <div class="card shadow-sm">
              <div class="card-header"> 
                <h5 class="mb-0 d-flex align-items-center">
                  <i class="bi bi-plus-square me-2"></i>ข้อมูลอาจารย์ผู้สอน
                </h5>
              </div>
              <div class="card-body p-4">
                <!-- ฟอร์มตัวอย่าง ยังไม่ผูก backend -->
                <form id="teacherForm" class="row g-3" method="post">
                  <!-- {% csrf_token %} -->
                  <div class="col-md-4">
                    <label class="form-label" for="teacher_name">อาจารย์</label>
                    <input id="teacher_name" type="text" class="form-control" placeholder="กรอกชื่ออาจารย์">
                  </div>
                  <div class="col-12">
                    <div class="d-flex justify-content-end mt-3">
                      <button id="btnAddTeacher" type="button" class="btn btn-primary-gradient px-4">
                        <i class="bi bi-plus-lg me-2"></i>เพิ่มข้อมูล
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>

            <!-- ตารางอาจารย์ผู้สอน (ให้อยู่ในแท็บเดียวกัน) -->
            <div class="card shadow-sm mt-4">
              <div class="card-header d-flex align-items-center">
                <i class="bi bi-table me-2"></i>
                <h5 class="mb-0">รายการอาจารย์ผู้สอน</h5>
              </div>
              <div class="card-body p-4">
                <div class="table-responsive table-rounded">
                  <table class="table align-middle mb-0">
                    <thead>
                      <tr>

                        <th>ชื่ออาจารย์</th>
                        <th>จัดการ</th>
                      </tr>
                    </thead>
                    <tbody id="teacherTableBody">
                      <tr class="empty-row">
                        <td colspan="3" class="text-center text-muted">ไม่มีข้อมูลอาจารย์ผู้สอน</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div class="d-flex justify-content-between mt-4">
                  <button id="btnRefreshTeacher" class="btn btn-success btn-lg px-4">
                    <i class="bi bi-arrow-clockwise me-2"></i>รีเฟรช
                  </button>
                  <button id="btnExportTeacherCSV" class="btn btn-success btn-lg px-4">
                    <i class="bi bi-download me-2"></i>ดาวน์โหลด CSV
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ข้อมูลกลุ่มนักศึกษา -->
          <div class="tab-pane fade" id="t-studentgroup" role="tabpanel" aria-labelledby="t-studentgroup-tab">
            <div class="card shadow-sm">
              <div class="card-header"> 
                <h5 class="mb-0 d-flex align-items-center">
                  <i class="bi bi-plus-square me-2"></i>ข้อมูลกลุ่มนักศึกษา
                </h5>
              </div>
              <div class="card-body p-4">
                <!-- ฟอร์มตัวอย่าง ยังไม่ผูก backend -->
                <form id="studentGroupForm" class="row g-3" method="post">
                  <!-- {% csrf_token %} -->
                  <div class="col-md-4">
                    <label class="form-label" for="group_name">ชื่อกลุ่มนักศึกษา</label>
                    <input id="group_name" type="text" class="form-control" placeholder="เช่น วศบ.1 ห้อง ก">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label" for="group_type">ประเภทนักศึกษา</label>
                    <select id="group_type" class="form-select">
                      <option selected disabled>เลือกประเภท</option>
                      <option>ภาคปกติ</option>
                      <option>ภาคพิเศษ</option>
                    </select>
                  </div>
                  <div class="col-12">
                    <div class="d-flex justify-content-end mt-3">
                      <button id="btnAddStudentGroup" type="button" class="btn btn-primary-gradient px-4">
                        <i class="bi bi-plus-lg me-2"></i>เพิ่มข้อมูล
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>

            <!-- ตารางกลุ่มนักศึกษา (ให้อยู่ในแท็บเดียวกัน) -->
            <div class="card shadow-sm mt-4">
              <div class="card-header d-flex align-items-center">
                <i class="bi bi-table me-2"></i>
                <h5 class="mb-0">รายการกลุ่มนักศึกษา</h5>
              </div>
              <div class="card-body p-4">
                <div class="table-responsive table-rounded">
                  <table class="table align-middle mb-0">
                    <thead>
                      <tr>
                        <th>ชื่อกลุ่มนักศึกษา</th>
                        <th>ประเภทนักศึกษา</th>
                        <th>จัดการ</th>
                      </tr>
                    </thead>
                    <tbody id="studentGroupTableBody">
                      <tr class="empty-row">
                        <td colspan="4" class="text-center text-muted">ไม่มีข้อมูลกลุ่มนักศึกษา</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div class="d-flex justify-content-between mt-4">
                  <button id="btnRefreshStudentGroup" class="btn btn-success btn-lg px-4">
                    <i class="bi bi-arrow-clockwise me-2"></i>รีเฟรช
                  </button>
                  <button id="btnExportStudentGroupCSV" class="btn btn-success btn-lg px-4">
                    <i class="bi bi-download me-2"></i>ดาวน์โหลด CSV
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ข้อมูลภาคนักศึกษา -->
          <div class="tab-pane fade" id="t-grouptype" role="tabpanel" aria-labelledby="t-grouptype-tab">
            <div class="card shadow-sm">
              <div class="card-header"> 
                <h5 class="mb-0 d-flex align-items-center">
                  <i class="bi bi-plus-square me-2"></i>ข้อมูลภาคนักศึกษา
                </h5>
              </div>
              <div class="card-body p-4">
                <!-- ฟอร์มตัวอย่าง ยังไม่ผูก backend -->
                <form id="groupTypeForm" class="row g-3" method="post">
                  <!-- {% csrf_token %} -->
                  <div class="col-md-4">
                    <label class="form-label" for="student_type">ประเภทนักศึกษา</label>
                    <select id="student_type" class="form-select">
                      <option selected disabled>เลือกประเภท</option>
                      <option>ภาคปกติ</option>
                      <option>ภาคพิเศษ</option>
                    </select>
                  </div>
                  <div class="col-12">
                    <div class="d-flex justify-content-end mt-3">
                      <button id="btnAddGroupType" type="button" class="btn btn-primary-gradient px-4">
                        <i class="bi bi-plus-lg me-2"></i>เพิ่มข้อมูล
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>

            <!-- ตารางภาคนักศึกษา (ให้อยู่ในแท็บเดียวกัน) -->
            <div class="card shadow-sm mt-4">
              <div class="card-header d-flex align-items-center">
                <i class="bi bi-table me-2"></i>
                <h5 class="mb-0">รายการภาคนักศึกษา</h5>
              </div>
              <div class="card-body p-4">
                <div class="table-responsive table-rounded">
                  <table class="table align-middle mb-0">
                    <thead>
                      <tr>
                        <th>ประเภทนักศึกษา</th>
                        <th>จัดการ</th>
                      </tr>
                    </thead>
                    <tbody id="groupTypeTableBody">
                      <tr class="empty-row">
                        <td colspan="3" class="text-center text-muted">ไม่มีข้อมูลภาคนักศึกษา</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div class="d-flex justify-content-between mt-4">
                  <button id="btnRefreshGroupType" class="btn btn-success btn-lg px-4">
                    <i class="bi bi-arrow-clockwise me-2"></i>รีเฟรช
                  </button>
                  <button id="btnExportGroupTypeCSV" class="btn btn-success btn-lg px-4">
                    <i class="bi bi-download me-2"></i>ดาวน์โหลด CSV
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ข้อมูลคาบที่เรียนได้ -->
          <div class="tab-pane fade" id="t-groupallow" role="tabpanel" aria-labelledby="t-groupallow-tab">
            <div class="card shadow-sm">
              <div class="card-header"> 
                <h5 class="mb-0 d-flex align-items-center">
                  <i class="bi bi-plus-square me-2"></i>ข้อมูลคาบที่เรียนได้
                </h5>
              </div>
              <div class="card-body p-4">
                <!-- ฟอร์มตัวอย่าง ยังไม่ผูก backend -->
                <form id="groupAllowForm" class="row g-3" method="post">
                  <!-- {% csrf_token %} -->
                  <div class="col-md-4">
                    <label class="form-label" for="ga_dept_id">รหัสภาค</label>
                    <input id="ga_dept_id" type="number" class="form-control" placeholder="1">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label" for="ga_slot_id">รหัสคาบ</label>
                    <input id="ga_slot_id" type="number" class="form-control" placeholder="1">
                  </div>
                  <div class="col-12">
                    <div class="d-flex justify-content-end mt-3">
                      <button id="btnAddGroupAllow" type="button" class="btn btn-primary-gradient px-4">
                        <i class="bi bi-plus-lg me-2"></i>เพิ่มข้อมูล
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>

            <!-- ตารางคาบที่เรียนได้ (ให้อยู่ในแท็บเดียวกัน) -->
            <div class="card shadow-sm mt-4">
              <div class="card-header d-flex align-items-center">
                <i class="bi bi-table me-2"></i>
                <h5 class="mb-0">รายการคาบที่เรียนได้</h5>
              </div>
              <div class="card-body p-4">
                <div class="table-responsive table-rounded">
                  <table class="table align-middle mb-0">
                    <thead>
                      <tr>
                        <th>รหัสภาค</th>
                        <th>รหัสคาบ</th>
                        <th>จัดการ</th>
                      </tr>
                    </thead>
                    <tbody id="groupAllowTableBody">
                      <tr class="empty-row">
                        <td colspan="3" class="text-center text-muted">ไม่มีข้อมูลคาบที่เรียนได้</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div class="d-flex justify-content-between mt-4">
                  <button id="btnRefreshGroupAllow" class="btn btn-success btn-lg px-4">
                    <i class="bi bi-arrow-clockwise me-2"></i>รีเฟรช
                  </button>
                  <button id="btnExportGroupAllowCSV" class="btn btn-success btn-lg px-4">
                    <i class="bi bi-download me-2"></i>ดาวน์โหลด CSV
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ข้อมูลห้องเรียน -->
          <div class="tab-pane fade" id="t-room" role="tabpanel" aria-labelledby="t-room-tab">
            <div class="card shadow-sm">
              <div class="card-header"> 
                <h5 class="mb-0 d-flex align-items-center">
                  <i class="bi bi-plus-square me-2"></i>ข้อมูลห้องเรียน
                </h5>
              </div>
              <div class="card-body p-4">
                <!-- ฟอร์มตัวอย่าง ยังไม่ผูก backend -->
                <form id="roomForm" class="row g-3" method="post">
                  <!-- {% csrf_token %} -->
                  <div class="col-md-4">
                    <label class="form-label" for="room_name">ชื่อห้องเรียน</label>
                    <input id="room_name" type="text" class="form-control" placeholder="เช่น ทค1-101">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label" for="room_type">ประเภทห้อง</label>
                    <select id="room_type" class="form-select">
                      <option selected disabled>เลือกประเภท</option>
                      <option>ห้องปกติ</option>
                      <option>ห้องไฟฟ้า</option>
                      <option>ห้อง IoT</option>
                    </select>
                  </div>
                  <div class="col-12">
                    <div class="d-flex justify-content-end mt-3">
                      <button id="btnAddRoom" type="button" class="btn btn-primary-gradient px-4">
                        <i class="bi bi-plus-lg me-2"></i>เพิ่มข้อมูล
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>

            <!-- ตารางห้องเรียน (ให้อยู่ในแท็บเดียวกัน) -->
            <div class="card shadow-sm mt-4">
              <div class="card-header d-flex align-items-center">
                <i class="bi bi-table me-2"></i>
                <h5 class="mb-0">รายการห้องเรียน</h5>
              </div>
              <div class="card-body p-4">
                <div class="table-responsive table-rounded">
                  <table class="table align-middle mb-0">
                    <thead>
                      <tr>
                        <th>ชื่อห้องเรียน</th>
                        <th>ประเภทห้อง</th>
                        <th>จัดการ</th>
                      </tr>
                    </thead>
                    <tbody id="roomTableBody">
                      <tr class="empty-row">
                        <td colspan="4" class="text-center text-muted">ไม่มีข้อมูลห้องเรียน</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div class="d-flex justify-content-between mt-4">
                  <button id="btnRefreshRoom" class="btn btn-success btn-lg px-4">
                    <i class="bi bi-arrow-clockwise me-2"></i>รีเฟรช
                  </button>
                  <button id="btnExportRoomCSV" class="btn btn-success btn-lg px-4">
                    <i class="bi bi-download me-2"></i>ดาวน์โหลด CSV
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ข้อมูลประเภทห้องเรียน -->
          <div class="tab-pane fade" id="t-roomtype" role="tabpanel" aria-labelledby="t-roomtype-tab">
            <div class="card shadow-sm">
              <div class="card-header">
                <h5 class="mb-0 d-flex align-items-center">
                  <i class="bi bi-grid-3x3-gap me-2"></i>ข้อมูลประเภทห้องเรียน
                </h5>
              </div>
              <div class="card-body p-4">
                <!-- ฟอร์มตัวอย่าง ยังไม่ผูก backend -->
                <form id="roomTypeForm" class="row g-3" method="post">
                  <!-- {% csrf_token %} -->
                  <div class="col-md-4">
                    <label class="form-label" for="roomtype_name">ชื่อประเภทห้อง</label>
                    <input id="roomtype_name" type="text" class="form-control" placeholder="เช่น ห้องบรรยาย">
                  </div>
                  <div class="col-12">
                    <div class="d-flex justify-content-end mt-3">
                      <button id="btnAddRoomType" type="button" class="btn btn-primary-gradient px-4">
                        <i class="bi bi-plus-lg me-2"></i>เพิ่มข้อมูล
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>

            <!-- ตารางประเภทห้องเรียน (ให้อยู่ในแท็บเดียวกัน) -->
            <div class="card shadow-sm mt-4">
              <div class="card-header d-flex align-items-center">
                <i class="bi bi-table me-2"></i>
                <h5 class="mb-0">รายการประเภทห้องเรียน</h5>
              </div>
              <div class="card-body p-4">
                <div class="table-responsive table-rounded">
                  <table class="table align-middle mb-0">
                    <thead>
                      <tr>
                        <th>ชื่อประเภทห้อง</th>
                        <th>จัดการ</th>
                      </tr>
                    </thead>
                    <tbody id="roomTypeTableBody">
                      <tr class="empty-row">
                        <td colspan="3" class="text-center text-muted">ไม่มีข้อมูลประเภทห้องเรียน</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div class="d-flex justify-content-between mt-4">
                  <button id="btnRefreshRoomType" class="btn btn-success btn-lg px-4">
                    <i class="bi bi-arrow-clockwise me-2"></i>รีเฟรช
                  </button>
                  <button id="btnExportRoomTypeCSV" class="btn btn-success btn-lg px-4">
                    <i class="bi bi-download me-2"></i>ดาวน์โหลด CSV
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ข้อมูลคาบเวลา -->
          <div class="tab-pane fade" id="t-timeslot" role="tabpanel" aria-labelledby="t-timeslot-tab">
            <div class="card shadow-sm">
              <div class="card-header"><h5 class="mb-0">ข้อมูลคาบเวลา</h5></div>
              <div class="card-body p-4">
                <!-- ฟอร์มตัวอย่าง ยังไม่ผูก backend -->
                <form id="timeslotForm" class="row g-3" method="post">
                  <!-- {% csrf_token %} -->
                  <div class="col-md-4">
                    <label class="form-label" for="ts_day">วัน</label>
                    <select id="ts_day" class="form-select">
                      <option selected disabled>เลือกวัน</option>
                      <option>จันทร์</option>
                      <option>อังคาร</option>
                      <option>พุธ</option>
                      <option>พฤหัสบดี</option>
                      <option>ศุกร์</option>
                      <option>เสาร์</option>
                      <option>อาทิตย์</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label" for="ts_start">เวลาเริ่ม</label>
                    <input id="ts_start" type="time" class="form-control">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label" for="ts_end">เวลาสิ้นสุด</label>
                    <input id="ts_end" type="time" class="form-control">
                  </div>
                  <div class="col-12">
                    <div class="d-flex justify-content-end mt-3">
                      <button id="btnAddTimeSlot" type="button" class="btn btn-primary-gradient px-4">
                        <i class="bi bi-plus-lg me-2"></i>เพิ่มข้อมูล
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>

            <!-- ตารางคาบเวลา (ให้อยู่ในแท็บเดียวกัน) -->
            <div class="card shadow-sm mt-4">
              <div class="card-header d-flex align-items-center">
                <i class="bi bi-table me-2"></i>
                <h5 class="mb-0">รายการคาบเวลา</h5>
              </div>
              <div class="card-body p-4">
                <div class="table-responsive table-rounded">
                  <table class="table align-middle mb-0">
                    <thead>
                      <tr>
                        <th>วัน</th>
                        <th>เวลาเริ่ม</th>
                        <th>เวลาสิ้นสุด</th>
                        <th>จัดการ</th>
                      </tr>
                    </thead>
                    <tbody id="timeslotTableBody">
                      <tr class="empty-row">
                        <td colspan="5" class="text-center text-muted">ไม่มีข้อมูลคาบเวลา</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div class="d-flex justify-content-between mt-4">
                  <button id="btnRefreshTimeSlot" class="btn btn-success btn-lg px-4">
                    <i class="bi bi-arrow-clockwise me-2"></i>รีเฟรช
                  </button>
                  <button id="btnExportTimeSlotCSV" class="btn btn-success btn-lg px-4">
                    <i class="bi bi-download me-2"></i>ดาวน์โหลด CSV
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ข้อมูลกิจกรรม -->
          <div class="tab-pane fade" id="t-weekactivity" role="tabpanel" aria-labelledby="t-weekactivity-tab">
            <div class="card shadow-sm">
              <div class="card-header"><h5 class="mb-0">ข้อมูลกิจกรรม</h5></div>
              <div class="card-body p-4">
                <!-- ฟอร์มตัวอย่าง ยังไม่ผูก backend -->
                <form id="weekActivityForm" class="row g-3" method="post">
                  <!-- {% csrf_token %} -->
                  <div class="col-md-4">
                    <label class="form-label" for="wa_name">ชื่อกิจกรรม</label>
                    <input id="wa_name" type="text" class="form-control" placeholder="เช่น คาบกิจกรรม">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label" for="wa_start">เวลาเริ่ม</label>
                    <input id="wa_start" type="time" class="form-control">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label" for="wa_end">เวลาสิ้นสุด</label>
                    <input id="wa_end" type="time" class="form-control">
                  </div>
                  <div class="col-12">
                    <div class="d-flex justify-content-end mt-3">
                      <button id="btnAddWeekActivity" type="button" class="btn btn-primary-gradient px-4">
                        <i class="bi bi-plus-lg me-2"></i>เพิ่มข้อมูล
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>

            <!-- ตารางกิจกรรม (ให้อยู่ในแท็บเดียวกัน) -->
            <div class="card shadow-sm mt-4">
              <div class="card-header d-flex align-items-center">
                <i class="bi bi-table me-2"></i>
                <h5 class="mb-0">รายการกิจกรรม</h5>
              </div>
              <div class="card-body p-4">
                <div class="table-responsive table-rounded">
                  <table class="table align-middle mb-0">
                    <thead>
                      <tr>
                        <th>ชื่อกิจกรรม</th>
                        <th>เวลาเริ่ม</th>
                        <th>เวลาสิ้นสุด</th>
                        <th>จัดการ</th>
                      </tr>
                    </thead>
                    <tbody id="weekActivityTableBody">
                      <tr class="empty-row">
                        <td colspan="5" class="text-center text-muted">ไม่มีข้อมูลกิจกรรม</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div class="d-flex justify-content-between mt-4">
                  <button id="btnRefreshWeekActivity" class="btn btn-success btn-lg px-4">
                    <i class="bi bi-arrow-clockwise me-2"></i>รีเฟรช
                  </button>
                  <button id="btnExportWeekActivityCSV" class="btn btn-success btn-lg px-4">
                    <i class="bi bi-download me-2"></i>ดาวน์โหลด CSV
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
   <script>
  // เปิดแท็บตาม hash ถ้ามี
  document.addEventListener('DOMContentLoaded', function () {
    if (location.hash) {
      const trigger = document.querySelector('a[data-bs-toggle="pill"][href="' + location.hash + '"]');
      if (trigger) new bootstrap.Tab(trigger).show();
    }
    document.querySelectorAll('a[data-bs-toggle="pill"]').forEach(el => {
      el.addEventListener('shown.bs.tab', e => history.replaceState(null, '', e.target.getAttribute('href')));
    });
  });

  // ===== Helper: CSV Export =====
  function exportCSV(headers, rows, filename) {
    const csv = [headers, ...rows]
      .map(r => r.map(v => '"' + String(v ?? '').replace(/"/g,'""') + '"').join(','))
      .join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }

  // ===== Generic controller factory for tables =====
  (function(){
    function byId(id){ return document.getElementById(id); }

    function makeController(cfg){
      const state = { data: [], editIndex: -1 };

      function getFieldEls(){ return cfg.fields.map(f => ({...f, el: byId(f.id)})); }

      function setAddBtnText(text){
        const addBtn = byId(cfg.addBtnId);
        if (!addBtn) return;
        const span = addBtn.querySelector('span');
        if (span) span.textContent = text; else addBtn.textContent = text;
      }

      function resetForm(){
        byId(cfg.formId)?.reset?.();
        state.editIndex = -1;
        byId(cfg.cancelBtnId)?.classList.add('d-none');
        setAddBtnText('เพิ่มข้อมูล');
      }

      function validateAndCollect(){
        const values = {};
        for (const f of getFieldEls()){
          let val = f.el.value;
          if (typeof val === 'string') val = val.trim();
          if (f.required && (!val || val === f.requiredInvalidValue)) {
            alert('กรอก/เลือก ' + (f.label || f.id) + ' ให้ครบ');
            return null;
          }
          values[f.key] = val;
        }
        return values;
      }

      function render(){
        const tbody = byId(cfg.tableBodyId); if (!tbody) return;
        tbody.innerHTML = '';
        if (state.data.length === 0){
          const colspan = cfg.fields.length + 1;
          tbody.innerHTML = '<tr class="empty-row"><td colspan="'+colspan+'" class="text-center text-muted">ไม่มีข้อมูล</td></tr>';
          return;
        }
        state.data.forEach((row, i) => {
          const cols = cfg.fields.map(f => '<td>' + (row[f.key] ?? '') + '</td>').join('');
          tbody.insertAdjacentHTML('beforeend',
            '<tr>' + cols + '<td><div class="btn-group btn-group-sm">' +
            '<button class="btn btn-outline-secondary" data-act="edit" data-i="'+i+'"><i class="bi bi-pencil"></i></button>' +
            '<button class="btn btn-outline-danger" data-act="remove" data-i="'+i+'"><i class="bi bi-trash"></i></button>' +
            '</div></td></tr>');
        });
        tbody.querySelectorAll('button[data-act]').forEach(btn => {
          btn.onclick = () => {
            const i = parseInt(btn.getAttribute('data-i'));
            const act = btn.getAttribute('data-act');
            if (act === 'edit') startEdit(i);
            if (act === 'remove') remove(i);
          };
        });
      }

      function startEdit(i){
        const row = state.data[i];
        for (const f of getFieldEls()){ f.el.value = row[f.key] ?? ''; }
        state.editIndex = i;
        setAddBtnText('บันทึกการแก้ไข');
        byId(cfg.cancelBtnId)?.classList.remove('d-none');
      }

      function remove(i){
        state.data.splice(i,1);
        if (state.editIndex === i) resetForm();
        render();
      }

      // Bind events
      byId(cfg.addBtnId)?.addEventListener('click', () => {
        const values = validateAndCollect(); if (!values) return;
        if (state.editIndex === -1) state.data.push(values);
        else state.data[state.editIndex] = values;
        render();
        resetForm();
      });
      byId(cfg.cancelBtnId)?.addEventListener('click', resetForm);
      byId(cfg.refreshBtnId)?.addEventListener('click', render);
      byId(cfg.exportBtnId)?.addEventListener('click', () => {
        const rows = state.data.map(item => cfg.fields.map(f => item[f.key] ?? ''));
        exportCSV(cfg.headers, rows, cfg.filename);
      });

      // Initial render
      render();
      return { render, startEdit, remove, resetForm, state };
    }

    // Create controllers after DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      makeController({
        key:'subject',
        formId:'subjectForm',
        fields:[
          {id:'subject_code', key:'code', label:'รหัสวิชา', required:true},
          {id:'subject_name', key:'name', label:'ชื่อรายวิชา', required:true},
        ],
        tableBodyId:'subjectTableBody',
        headers:['รหัสวิชา','ชื่อรายวิชา'],
        filename:'subjects.csv',
        addBtnId:'btnAddSubject',
        cancelBtnId:'btnCancelSubjectEdit',
        refreshBtnId:'btnRefreshSubject',
        exportBtnId:'btnExportSubjectCSV',
      });

      makeController({
        key:'teacher',
        formId:'teacherForm',
        fields:[
          {id:'teacher_id', key:'id', label:'รหัสอาจารย์', required:true},
          {id:'teacher_name', key:'name', label:'ชื่ออาจารย์', required:true},
        ],
        tableBodyId:'teacherTableBody',
        headers:['รหัสอาจารย์','ชื่ออาจารย์'],
        filename:'teachers.csv',
        addBtnId:'btnAddTeacher',
        cancelBtnId:'btnCancelTeacherEdit',
        refreshBtnId:'btnRefreshTeacher',
        exportBtnId:'btnExportTeacherCSV',
      });

      makeController({
        key:'studentgroup',
        formId:'studentGroupForm',
        fields:[
          {id:'group_id', key:'id', label:'รหัสกลุ่มนักศึกษา', required:true},
          {id:'group_name', key:'name', label:'ชื่อกลุ่มนักศึกษา', required:true},
          {id:'group_type', key:'type', label:'ประเภทนักศึกษา', required:true, requiredInvalidValue:'เลือกประเภท'},
        ],
        tableBodyId:'studentGroupTableBody',
        headers:['รหัสกลุ่มนักศึกษา','ชื่อกลุ่มนักศึกษา','ประเภทนักศึกษา'],
        filename:'student_groups.csv',
        addBtnId:'btnAddStudentGroup',
        cancelBtnId:'btnCancelStudentGroupEdit',
        refreshBtnId:'btnRefreshStudentGroup',
        exportBtnId:'btnExportStudentGroupCSV',
      });

      makeController({
        key:'grouptype',
        formId:'groupTypeForm',
        fields:[
          {id:'dept_id', key:'id', label:'รหัสภาค', required:true},
          {id:'student_type', key:'type', label:'ประเภทนักศึกษา', required:true, requiredInvalidValue:'เลือกประเภท'},
        ],
        tableBodyId:'groupTypeTableBody',
        headers:['รหัสภาค','ประเภทนักศึกษา'],
        filename:'group_types.csv',
        addBtnId:'btnAddGroupType',
        cancelBtnId:'btnCancelGroupTypeEdit',
        refreshBtnId:'btnRefreshGroupType',
        exportBtnId:'btnExportGroupTypeCSV',
      });

      makeController({
        key:'groupallow',
        formId:'groupAllowForm',
        fields:[
          {id:'ga_dept_id', key:'dept', label:'รหัสภาค', required:true},
          {id:'ga_slot_id', key:'slot', label:'รหัสคาบ', required:true},
        ],
        tableBodyId:'groupAllowTableBody',
        headers:['รหัสภาค','รหัสคาบ'],
        filename:'group_allow.csv',
        addBtnId:'btnAddGroupAllow',
        cancelBtnId:'btnCancelGroupAllowEdit',
        refreshBtnId:'btnRefreshGroupAllow',
        exportBtnId:'btnExportGroupAllowCSV',
      });

      makeController({
        key:'room',
        formId:'roomForm',
        fields:[
          {id:'room_id', key:'id', label:'รหัสห้อง', required:true},
          {id:'room_name', key:'name', label:'ชื่อห้องเรียน', required:true},
          {id:'room_type', key:'type', label:'ประเภทห้อง', required:true, requiredInvalidValue:'เลือกประเภท'},
        ],
        tableBodyId:'roomTableBody',
        headers:['รหัสห้อง','ชื่อห้องเรียน','ประเภทห้อง'],
        filename:'rooms.csv',
        addBtnId:'btnAddRoom',
        cancelBtnId:'btnCancelRoomEdit',
        refreshBtnId:'btnRefreshRoom',
        exportBtnId:'btnExportRoomCSV',
      });

      makeController({
        key:'roomtype',
        formId:'roomTypeForm',
        fields:[
          {id:'roomtype_id', key:'id', label:'รหัสประเภทห้อง', required:true},
          {id:'roomtype_name', key:'name', label:'ชื่อประเภทห้อง', required:true},
        ],
        tableBodyId:'roomTypeTableBody',
        headers:['รหัสประเภทห้อง','ชื่อประเภทห้อง'],
        filename:'room_types.csv',
        addBtnId:'btnAddRoomType',
        cancelBtnId:'btnCancelRoomTypeEdit',
        refreshBtnId:'btnRefreshRoomType',
        exportBtnId:'btnExportRoomTypeCSV',
      });

      makeController({
        key:'timeslot',
        formId:'timeslotForm',
        fields:[
          {id:'ts_id', key:'id', label:'รหัสคาบ', required:true},
          {id:'ts_day', key:'day', label:'วัน', required:true, requiredInvalidValue:'เลือกวัน'},
          {id:'ts_start', key:'start', label:'เวลาเริ่ม', required:true},
          {id:'ts_end', key:'end', label:'เวลาสิ้นสุด', required:true},
        ],
        tableBodyId:'timeslotTableBody',
        headers:['รหัสคาบ','วัน','เวลาเริ่ม','เวลาสิ้นสุด'],
        filename:'timeslots.csv',
        addBtnId:'btnAddTimeSlot',
        cancelBtnId:'btnCancelTimeSlotEdit',
        refreshBtnId:'btnRefreshTimeSlot',
        exportBtnId:'btnExportTimeSlotCSV',
      });

      makeController({
        key:'weekactivity',
        formId:'weekActivityForm',
        fields:[
          {id:'wa_id', key:'id', label:'รหัสกิจกรรม', required:true},
          {id:'wa_name', key:'name', label:'ชื่อกิจกรรม', required:true},
          {id:'wa_start', key:'start', label:'เวลาเริ่ม', required:true},
          {id:'wa_end', key:'end', label:'เวลาสิ้นสุด', required:true},
        ],
        tableBodyId:'weekActivityTableBody',
        headers:['รหัสกิจกรรม','ชื่อกิจกรรม','เวลาเริ่ม','เวลาสิ้นสุด'],
        filename:'week_activities.csv',
        addBtnId:'btnAddWeekActivity',
        cancelBtnId:'btnCancelWeekActivityEdit',
        refreshBtnId:'btnRefreshWeekActivity',
        exportBtnId:'btnExportWeekActivityCSV',
      });
    });
  })();
  </script>

  <script>
    function showNotification(message, type = 'info', duration = 5000) {
      const container = document.getElementById('notificationContainer');
      const notification = document.createElement('div');
      
      const typeMap = {
        'success': 'success',
        'error': 'error', 
        'warning': 'warning',
        'info': 'info',
        'debug': 'info'
      };
      
      const notificationType = typeMap[type] || 'info';
      
      notification.className = `notification ${notificationType}`;
      notification.innerHTML = `
        <button class="notification-close" onclick="closeNotification(this)">&times;</button>
        <div>${message}</div>
        <div class="notification-progress"></div>
      `;
      
      container.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);
      
      const progressBar = notification.querySelector('.notification-progress');
      progressBar.style.width = '100%';
      setTimeout(() => {
        progressBar.style.width = '0%';
        progressBar.style.transitionDuration = duration + 'ms';
      }, 100);
      
      setTimeout(() => {
        closeNotification(notification.querySelector('.notification-close'));
      }, duration);
    }

    function closeNotification(button) {
      const notification = button.parentElement;
      notification.style.opacity = '0';
      notification.style.transform = 'translateX(100%)';
      setTimeout(() => {
        if (notification.parentElement) {
          notification.parentElement.removeChild(notification);
        }
      }, 300);
    }

    // เปิดแท็บตาม hash (#t-add ฯลฯ) และอัปเดต hash เมื่อสลับแท็บ
    const hash = window.location.hash;
    if (hash && document.querySelector(`[href="${hash}"]`)) {
      new bootstrap.Tab(document.querySelector(`[href="${hash}"]`)).show();
    }
    document.querySelectorAll('#sideTab a[data-bs-toggle="pill"]').forEach(a => {
      a.addEventListener('shown.bs.tab', e => {
        history.replaceState(null, '', e.target.getAttribute('href'));
      });
    });

    window.onload = function() {
      showNotification("ยินดีต้อนรับสู่หน้าเพิ่มข้อมูล", 'info');
    };
  </script>
</body>
</html>
