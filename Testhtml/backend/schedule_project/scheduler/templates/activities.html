{% load static %}
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ข้อมูลกิจกรรม - ระบบจัดตารางสอน</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        body {
            background-color: #eaedffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .header-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #6b7280;
            font-weight: 500;
            padding: 1rem 1.5rem;
            border-bottom: 3px solid transparent;
            background: none;
        }
        
        .nav-tabs .nav-link.active {
            background: none;
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }
        
        .nav-tabs .nav-link:hover {
            border-color: transparent;
            color: #374151;
            background: none;
        }
        
        .content-card {
            border: 2px solid #d1d5db !important;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            background: white;
            transition: all 0.2s;
        }
        
        .content-card:hover {
            border-color: #9ca3af !important;
            box-shadow: 0 8px 12px -2px rgba(0, 0, 0, 0.15);
        }
        
        .card-header-purple {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 1.5rem;
            border: none;
            border-radius: 14px 14px 0 0 !important;
        }
        
        .btn-primary-gradient {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            border: none;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.2s;
            color: white;
        }
        
        .btn-primary-gradient:hover {
            background: linear-gradient(135deg, #4338ca, #6d28d9);
            transform: translateY(-1px);
            color: white;
        }
        
        .btn-success-gradient {
            background: linear-gradient(135deg, #059669, #047857);
            border: none;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.2s;
            color: white;
        }
        
        .btn-success-gradient:hover {
            background: linear-gradient(135deg, #047857, #065f46);
            transform: translateY(-1px);
            color: white;
        }
        
        .btn-warning-gradient {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.2s;
            color: white;
        }
        
        .btn-warning-gradient:hover {
            background: linear-gradient(135deg, #d97706, #b45309);
            transform: translateY(-1px);
            color: white;
        }
        
        .btn-danger-gradient {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.2s;
            color: white;
        }
        
        .btn-danger-gradient:hover {
            background: linear-gradient(135deg, #b91c1c, #991b1b);
            transform: translateY(-1px);
            color: white;
        }
        
        .form-control, .form-select {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            transition: all 0.2s;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 0.2rem rgba(79, 70, 229, 0.25);
        }
        
        .table-container {
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }
        
        .table th {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: none;
            padding: 1rem 0.5rem;
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
            text-align: center;
        }
        
        .table td {
            border: none;
            padding: 1rem 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            text-align: center;
            font-size: 0.875rem;
        }
        
        .table tbody tr:hover {
            background-color: #f8fafc;
        }
        
        /* Notification Styles */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }

        .notification {
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background-color: #d1fae5;
            border-left: 4px solid #10b981;
            color: #065f46;
        }

        .notification.error {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
            color: #991b1b;
        }

        .notification.warning {
            background-color: #fef3c7;
            border-left: 4px solid #f59e0b;
            color: #92400e;
        }

        .notification.info {
            background-color: #dbeafe;
            border-left: 4px solid #3b82f6;
            color: #1e40af;
        }

        .notification-close {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.7;
        }

        .notification-close:hover {
            opacity: 1;
        }

        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background-color: rgba(0,0,0,0.2);
            transition: width linear;
        }
        
        .badge {
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
        }

        .divider-vertical {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            position: relative;
        }

        .divider-vertical::before {
            content: '';
            width: 2px;
            flex: 1;
            background: linear-gradient(135deg, #e5e7eb, #d1d5db);
        }

        .divider-vertical span {
            padding: 1rem 0;
            color: #6b7280;
            font-weight: 500;
            font-size: 0.875rem;
            background: white;
        }

        .divider-vertical::after {
            content: '';
            width: 2px;
            flex: 1;
            background: linear-gradient(135deg, #e5e7eb, #d1d5db);
        }

        @media (max-width: 768px) {
            .table th, .table td {
                padding: 0.5rem 0.25rem;
                font-size: 0.75rem;
            }
            
            .btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
        }
          .btn-consistent {
              min-width: 140px;
              height: 48px;
              font-weight: 600;
              border-radius: 12px;
              display: inline-flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
              transition: all 0.2s ease;
          }

          .btn-consistent:hover {
              transform: translateY(-1px);
              box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
          }

          .btn-primary-consistent {
              background: linear-gradient(135deg, #4f46e5, #7c3aed);
              border: none;
              color: white;
          }

          .btn-secondary-consistent {
              background: linear-gradient(135deg, #059669, #047857);
              border: none;
              color: white;
          }
    </style>
</head>
<body>
    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Header -->
    <header class="bg-white border-bottom py-3">
        <div class="container-fluid" style="max-width: 1400px;">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <div class="header-icon me-3">
                            <i class="bi bi-calendar-check text-white fs-4"></i>
                        </div>
                        <h1 class="h4 mb-0 fw-bold text-dark">ระบบจัดตารางสอน</h1>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-end align-items-center">
                        <button class="btn btn-outline-secondary me-3">
                            <i class="bi bi-file-text me-2"></i>คู่มือ
                        </button>
                        <button class="btn btn-outline-primary">
                            <i class="bi bi-person me-2"></i>เกี่ยวกับเรา
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <!-- Navigation -->
        <nav class="bg-white border-bottom">
        <div class="container-fluid" style="max-width: 1400px;">
            <ul class="nav nav-tabs border-0">
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}"
                href="{% url 'home' %}" {% if request.resolver_match.url_name == 'home' %}aria-current="page"{% endif %}>
                <i class="bi bi-house me-2"></i>หน้าหลัก
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'add' %}active{% endif %}"
                href="{% url 'add' %}" {% if request.resolver_match.url_name == 'add' %}aria-current="page"{% endif %}>
                <i class="bi bi-plus-square me-2"></i>เพิ่มข้อมูล
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'pre' %}active{% endif %}"
                href="{% url 'pre' %}" {% if request.resolver_match.url_name == 'pre' %}aria-current="page"{% endif %}>
                <i class="bi bi-book me-2"></i>ลงล่วงหน้า
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'teacher' %}active{% endif %}"
                href="{% url 'teacher' %}" {% if request.resolver_match.url_name == 'teacher' %}aria-current="page"{% endif %}>
                <i class="bi bi-people me-2"></i>รายวิชา
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'activities' %}active{% endif %}"
                href="{% url 'activities' %}" {% if request.resolver_match.url_name == 'activities' %}aria-current="page"{% endif %}>
                <i class="bi bi-activity me-2"></i>กิจกรรม
                </a>
            </li>
            </ul>
        </div>
        </nav>

    <!-- Django Messages -->
    {% if messages %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        {% for message in messages %}
            showNotification('{{ message|escapejs }}', '{{ message.tags }}');
        {% endfor %}
    });
    </script>
    {% endif %}

    <!-- Main Content -->
    <main class="container-fluid py-5" style="max-width: 1400px;">
        <div class="row g-4">
            <!-- Form Section -->
            <div class="col-12">
                <div class="card content-card">
                    <div class="card-header card-header-purple">
                        <h5 class="card-title mb-0 d-flex align-items-center">
                            <i class="bi bi-activity me-2"></i>
                            จัดการข้อมูลกิจกรรม
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-4">
                            <!-- CSV Upload Section -->
                            <div class="col-md-4">
                                <h6 class="fw-bold mb-3 text-dark">
                                    <i class="bi bi-upload me-2"></i>อัปโหลดไฟล์ CSV
                                </h6>
                                <form action="{% url 'upload_activities_csv' %}" method="post" enctype="multipart/form-data" id="csvUploadForm">
                                    {% csrf_token %}
                                    <div class="mb-3">
                                        <label for="csvFileInput" class="form-label">เลือกไฟล์ CSV</label>
                                        <input type="file" class="form-control" id="csvFileInput" name="file" accept=".csv" required>
                                        <div class="form-text">
                                            <small>รองรับไฟล์สกุล .csv เท่านั้น</small>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary-gradient w-100" id="uploadBtn">
                                        <i class="bi bi-cloud-upload me-2"></i>อัปโหลด CSV
                                    </button>
                                </form>
                            </div>

                            <!-- Divider Column -->
                            <div class="col-md-1 d-flex align-items-center justify-content-center">
                                <div class="divider-vertical">
                                    <span>หรือ</span>
                                </div>
                            </div>

                            <!-- Manual Input Form -->
                            <div class="col-md-7">
                                <h6 class="fw-bold mb-3 text-dark">
                                    <i class="bi bi-plus-circle me-2"></i>เพิ่มข้อมูล
                                </h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="act_name_activities" class="form-label">ชื่อกิจกรรม</label>
                                        <input type="text" class="form-control" id="act_name_activities" placeholder="กรอกชื่อกิจกรรม">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="day_activities" class="form-label">วัน</label>
                                        <select class="form-select" id="day_activities">
                                            <option value="">เลือกวัน</option>
                                            <option value="วันจันทร์">วันจันทร์</option>
                                            <option value="วันอังคาร">วันอังคาร</option>
                                            <option value="วันพุธ">วันพุธ</option>
                                            <option value="วันพฤหัสบดี">วันพฤหัสบดี</option>
                                            <option value="วันศุกร์">วันศุกร์</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="start_time_activities" class="form-label">เวลาเริ่ม</label>
                                        <select class="form-select" id="start_time_activities">
                                            <option value="">เลือกเวลาเริ่ม</option>
                                            <option value="08:00">08:00</option>
                                            <option value="09:00">09:00</option>
                                            <option value="10:00">10:00</option>
                                            <option value="11:00">11:00</option>
                                            <option value="12:00">12:00</option>
                                            <option value="13:00">13:00</option>
                                            <option value="14:00">14:00</option>
                                            <option value="15:00">15:00</option>
                                            <option value="16:00">16:00</option>
                                            <option value="17:00">17:00</option>
                                            <option value="18:00">18:00</option>
                                            <option value="19:00">19:00</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="stop_time_activities" class="form-label">เวลาสิ้นสุด</label>
                                        <select class="form-select" id="stop_time_activities">
                                            <option value="">เลือกเวลาสิ้นสุด</option>
                                            <option value="09:00">09:00</option>
                                            <option value="10:00">10:00</option>
                                            <option value="11:00">11:00</option>
                                            <option value="12:00">12:00</option>
                                            <option value="13:00">13:00</option>
                                            <option value="14:00">14:00</option>
                                            <option value="15:00">15:00</option>
                                            <option value="16:00">16:00</option>
                                            <option value="17:00">17:00</option>
                                            <option value="18:00">18:00</option>
                                            <option value="19:00">19:00</option>
                                            <option value="20:00">20:00</option>
                                        </select>
                                    </div>
                                    <div class="col-md-12">
                                      <div class="d-flex justify-content-end mt-4">
                                          <button class="btn btn-primary-gradient px-4 py-2" onclick="addActivity()">
                                              <i class="bi bi-plus-lg me-2"></i>เพิ่มข้อมูล
                                          </button>
                                      </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table Section -->
            <div class="col-12">
                <div class="card content-card h-100">
                    <div class="card-header card-header-purple">
                        <h5 class="card-title mb-0 d-flex align-items-center">
                            <i class="bi bi-table me-2"></i>
                            รายการกิจกรรม
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="table-container">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="dataTable">
                                    <thead>
                                        <tr>
                                            <th>ชื่อกิจกรรม</th>
                                            <th>วัน</th>
                                            <th>เวลาเริ่ม</th>
                                            <th>เวลาสิ้นสุด</th>
                                            <th>จัดการ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for activity in activities %}
                                        <tr data-id="{{ activity.id }}">
                                            <td>{{ activity.act_name_activities }}</td>
                                            <td><span class="badge bg-info">{{ activity.day_activities }}</span></td>
                                            <td><span class="badge bg-success">{{ activity.start_time_activities }}</span></td>
                                            <td><span class="badge bg-warning">{{ activity.stop_time_activities }}</span></td>
                                            <td>
                                                <button class="btn btn-warning-gradient btn-sm me-1" onclick="openEditModal(this)" title="แก้ไข">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-danger-gradient btn-sm" onclick="confirmDelete(this)" title="ลบ">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">ไม่มีข้อมูลกิจกรรม</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-4">
                            <button class="btn btn-consistent btn-secondary-consistent" onclick="refreshData()">
                                <i class="bi bi-arrow-clockwise me-2"></i>รีเฟรช
                            </button>
                            <button class="btn btn-success-gradient" onclick="downloadCSV()">
                                <i class="bi bi-download me-2"></i>ดาวน์โหลด CSV
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="border-radius: 16px; border: none;">
                <div class="modal-header" style="background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; border-radius: 16px 16px 0 0;">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil-square me-2"></i>แก้ไขข้อมูลกิจกรรม
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="edit_act_name_activities" class="form-label">ชื่อกิจกรรม</label>
                            <input type="text" class="form-control" id="edit_act_name_activities" placeholder="ชื่อกิจกรรม">
                        </div>
                        <div class="col-md-6">
                            <label for="edit_day_activities" class="form-label">วัน</label>
                            <select class="form-select" id="edit_day_activities">
                                <option value="">เลือกวัน</option>
                                <option value="วันจันทร์">วันจันทร์</option>
                                <option value="วันอังคาร">วันอังคาร</option>
                                <option value="วันพุธ">วันพุธ</option>
                                <option value="วันพฤหัสบดี">วันพฤหัสบดี</option>
                                <option value="วันศุกร์">วันศุกร์</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_start_time_activities" class="form-label">เวลาเริ่ม</label>
                            <select class="form-select" id="edit_start_time_activities">
                                <option value="">เลือกเวลาเริ่ม</option>
                                <option value="08:00">08:00</option>
                                <option value="09:00">09:00</option>
                                <option value="10:00">10:00</option>
                                <option value="11:00">11:00</option>
                                <option value="12:00">12:00</option>
                                <option value="13:00">13:00</option>
                                <option value="14:00">14:00</option>
                                <option value="15:00">15:00</option>
                                <option value="16:00">16:00</option>
                                <option value="17:00">17:00</option>
                                <option value="18:00">18:00</option>
                                <option value="19:00">19:00</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label for="edit_stop_time_activities" class="form-label">เวลาสิ้นสุด</label>
                            <select class="form-select" id="edit_stop_time_activities">
                                <option value="">เลือกเวลาสิ้นสุด</option>
                                <option value="09:00">09:00</option>
                                <option value="10:00">10:00</option>
                                <option value="11:00">11:00</option>
                                <option value="12:00">12:00</option>
                                <option value="13:00">13:00</option>
                                <option value="14:00">14:00</option>
                                <option value="15:00">15:00</option>
                                <option value="16:00">16:00</option>
                                <option value="17:00">17:00</option>
                                <option value="18:00">18:00</option>
                                <option value="19:00">19:00</option>
                                <option value="20:00">20:00</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" style="border-radius: 12px;">
                        <i class="bi bi-x-lg me-2"></i>ยกเลิก
                    </button>
                    <button type="button" class="btn btn-primary-gradient" onclick="saveEdit()">
                        <i class="bi bi-check-lg me-2"></i>บันทึกการแก้ไข
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <script>
        let editRow = null;
        let editId = null;

        // Notification System
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            
            const typeMap = {
                'success': 'success',
                'error': 'error', 
                'warning': 'warning',
                'info': 'info',
                'debug': 'info'
            };
            
            const notificationType = typeMap[type] || 'info';
            
            notification.className = `notification ${notificationType}`;
            notification.innerHTML = `
                <button class="notification-close" onclick="closeNotification(this)">&times;</button>
                <div>${message}</div>
                <div class="notification-progress"></div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            const progressBar = notification.querySelector('.notification-progress');
            progressBar.style.width = '100%';
            setTimeout(() => {
                progressBar.style.width = '0%';
                progressBar.style.transitionDuration = duration + 'ms';
            }, 100);
            
            setTimeout(() => {
                closeNotification(notification.querySelector('.notification-close'));
            }, duration);
        }

        function closeNotification(button) {
            const notification = button.parentElement;
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.parentElement.removeChild(notification);
                }
            }, 300);
        }

        // CSV Upload Form Handler
        document.getElementById('csvUploadForm').addEventListener('submit', function(e) {
            e.preventDefault(); // ป้องกัน default form submission
            
            const fileInput = document.getElementById('csvFileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (!fileInput.files.length) {
                showNotification('กรุณาเลือกไฟล์ CSV', 'warning');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            uploadBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>กำลังอัปโหลด...';
            uploadBtn.disabled = true;
            
            fetch('/upload/activities-csv/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showNotification(data.message, 'success');
                    location.reload();
                } else {
                    showNotification(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('เกิดข้อผิดพลาดในการอัปโหลดไฟล์', 'error');
            })
            .finally(() => {
                uploadBtn.innerHTML = '<i class="bi bi-cloud-upload me-2"></i>อัปโหลด CSV';
                uploadBtn.disabled = false;
                fileInput.value = '';
            });
        });

        function addActivity() {
            const act_name_activities = document.getElementById("act_name_activities").value.trim();
            const day_activities = document.getElementById("day_activities").value;
            const start_time_activities = document.getElementById("start_time_activities").value;
            const stop_time_activities = document.getElementById("stop_time_activities").value;

            if (!act_name_activities) {
                showNotification("กรุณากรอกชื่อกิจกรรม", 'warning');
                return;
            }

            if (!day_activities) {
                showNotification("กรุณาเลือกวัน", 'warning');
                return;
            }

            if (!start_time_activities) {
                showNotification("กรุณาเลือกเวลาเริ่ม", 'warning');
                return;
            }

            if (!stop_time_activities) {
                showNotification("กรุณาเลือกเวลาสิ้นสุด", 'warning');
                return;
            }

            // แก้ไข URL ให้ตรงกับ urls.py (เปลี่ยนจาก /api/activity/add/ เป็น /api/activities/add/)
            fetch('/api/activities/add/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    act_name_activities: act_name_activities,
                    day_activities: day_activities,
                    start_time_activities: start_time_activities,
                    stop_time_activities: stop_time_activities
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showNotification("✅ เพิ่มกิจกรรมเรียบร้อยแล้ว", 'success');
                    location.reload(); // Reload to show new data
                } else {
                    showNotification('เกิดข้อผิดพลาด: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('เกิดข้อผิดพลาดในการเพิ่มข้อมูล', 'error');
            });
        }

        function confirmDelete(button) {
            if (confirm("คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้?")) {
                const row = button.closest("tr");
                const id = row.getAttribute("data-id");
                
                // แก้ไข URL ให้ตรงกับ urls.py (เปลี่ยนจาก /api/activity/delete/ เป็น /api/activities/delete/)
                fetch(`/api/activities/delete/${id}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        row.remove();
                        showNotification("✅ ลบข้อมูลเรียบร้อยแล้ว", 'success');
                    } else {
                        showNotification('เกิดข้อผิดพลาดในการลบข้อมูล', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('เกิดข้อผิดพลาดในการลบข้อมูล', 'error');
                });
            }
        }

        function openEditModal(button) {
            editRow = button.closest("tr");
            editId = editRow.getAttribute("data-id");
            const cells = editRow.getElementsByTagName("td");
            
            document.getElementById("edit_act_name_activities").value = cells[0].innerText;
            document.getElementById("edit_day_activities").value = cells[1].querySelector('.badge').innerText;
            document.getElementById("edit_start_time_activities").value = cells[2].querySelector('.badge').innerText;
            document.getElementById("edit_stop_time_activities").value = cells[3].querySelector('.badge').innerText;
            
            new bootstrap.Modal(document.getElementById("editModal")).show();
        }

        function saveEdit() {
            const act_name_activities = document.getElementById("edit_act_name_activities").value;
            const day_activities = document.getElementById("edit_day_activities").value;
            const start_time_activities = document.getElementById("edit_start_time_activities").value;
            const stop_time_activities = document.getElementById("edit_stop_time_activities").value;

            if (!act_name_activities || !day_activities || !start_time_activities || !stop_time_activities) {
                showNotification("กรุณากรอกข้อมูลให้ครบถ้วน", 'warning');
                return;
            }

            // แก้ไข URL ให้ตรงกับ urls.py (เปลี่ยนจาก /api/activity/update/ เป็น /api/activities/update/)
            fetch(`/api/activities/update/${editId}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    act_name_activities: act_name_activities,
                    day_activities: day_activities,
                    start_time_activities: start_time_activities,
                    stop_time_activities: stop_time_activities
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showNotification("✅ แก้ไขข้อมูลเรียบร้อยแล้ว", 'success');
                    bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
                    location.reload(); // Reload to show updated data
                } else {
                    showNotification('เกิดข้อผิดพลาดในการแก้ไขข้อมูล', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('เกิดข้อผิดพลาดในการแก้ไขข้อมูล', 'error');
            });
        }

        function refreshData() {
            location.reload();
        }

        function downloadCSV() {
            let csv = "activity_name,day,start_time,stop_time\n";
            document.querySelectorAll("#dataTable tbody tr").forEach(row => {
                const cells = row.querySelectorAll("td");
                if (cells.length > 1) { // Skip empty row
                    const rowData = [
                        cells[0].textContent.trim(),
                        cells[1].querySelector('.badge').textContent.trim(),
                        cells[2].querySelector('.badge').textContent.trim(),
                        cells[3].querySelector('.badge').textContent.trim()
                    ].map(cell => `"${cell}"`).join(",");
                    csv += rowData + "\n";
                }
            });

            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.setAttribute("download", "กิจกรรม.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification("✅ ดาวน์โหลดไฟล์ CSV เรียบร้อยแล้ว", 'success');
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Initial load
        window.onload = function() {
            showNotification("ยินดีต้อนรับสู่หน้าจัดการกิจกรรม", 'info');
        };
    </script>
</body>
</html>
